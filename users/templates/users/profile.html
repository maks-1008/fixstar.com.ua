{% extends "base.html" %}
{% load static %}
 
{% block css %}
  <link rel="stylesheet" href="{% static 'deps/css/my_footer_css.css' %}">
  <link rel="stylesheet" href="{% static 'deps/css/subcategory_detail.css' %}">
  <link rel="stylesheet" href="{% static 'deps/css/search_results.css' %}">
  <link rel="stylesheet" href="{% static 'deps/css/my_css.css' %}">
  <style>
    .password-field {
      position: relative;
    }
    
    .password-toggle {
      position: absolute;
      right: 10px;
      top: 50%;
      transform: translateY(-50%);
      background: none;
      border: none;
      color: #6c757d;
      cursor: pointer;
      z-index: 10;
      padding: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .password-info {
      margin-bottom: 5px;
      font-size: 12px;
    }
  </style>
{% endblock %} 

{% block content %}
<!-- Контент на странице -->
<div class="row">
    <div class="container mt-5">
        <div class="row">
            <!-- Профиль с данными пользователя -->
            <div class="col-md-5">
                <div class=" bg-white p-4 mb-4 mx-2 rounded custom-shadow">
                    <h3 class="text-center mb-4">Профіль користувача</h3>
                    <form action="{% url 'users:profile' %}" method="post" enctype="multipart/form-data" id="profileForm" autocomplete="off">
                        {% csrf_token %}
                        <div class="row">
                            <div class="col-md-12 mb-3 text-center">
                                {% if user.image %}
                                    <img src="{{ user.image.url }}" alt="Аватар користувача" class="img-fluid rounded-circle" style="max-width: 150px;">
                                {% else %}
                                    <img src="{% static 'deps/images/baseavatar.jpg' %}" alt="Аватар користувача" class="img-fluid rounded-circle" style="max-width: 150px;">
                                {% endif %}
                                
                                {{ form.image }}  <!-- Используем поле из формы вместо ручного input -->
                                
                                {% if form.image.errors %}
                                    <div class="alert alert-danger alert-dismissible fade show">{{ form.image.errors }}</div>
                                {% endif %}
                            </div>
                            <div class="col-md-12 mb-3">
                                <label for="id_first_name" class="form-label">Ім'я*</label>
                                <input type="text" class="form-control" id="id_first_name"
                                    name="first_name"
                                    placeholder="Введіть ваше ім'я"
                                    value="{{ form.first_name.value }}"
                                    required>
                                    {% if form.first_name.errors %}
                                    <div class="alert alert-danger alert-dismissible fade show">{{ form.first_name.errors }}</div>
                                    {% endif %}
                            </div>
                            <div class="col-md-12 mb-3">
                                <label for="id_last_name" class="form-label">Прізвище*</label>
                                <input type="text" class="form-control" id="id_last_name"
                                    name="last_name"
                                    placeholder="Введіть ваше прізвище"
                                    value="{{ form.last_name.value }}" 
                                    required>
                                    {% if form.last_name.errors %}
                                    <div class="alert alert-danger alert-dismissible fade show">{{ form.last_name.errors }}</div>
                                    {% endif %}
                            </div>
                            <div class="col-md-12 mb-3">
                                <label for="id_username" class="form-label">Логін*</label>
                                <input type="text" class="form-control" id="id_username"
                                    name="username"
                                    placeholder="Введіть ваше ім'я користувача" 
                                    value="{{ form.username.value }}" 
                                    required>
                                    {% if form.username.errors %}
                                    <div class="alert alert-danger alert-dismissible fade show">{{ form.username.errors }}</div>
                                    {% endif %}
                            </div>
                            <div class="col-md-12 mb-3">
                                <label for="id_email" class="form-label">Email*</label>
                                <input type="email" class="form-control" id="id_email"
                                    name="email"
                                    placeholder="Введіть ваш email *youremail@example.com" 
                                    value="{{ form.email.value }}"
                                    required>
                                    {% if form.email.errors %}
                                    <div class="alert alert-danger alert-dismissible fade show">{{ form.email.errors }}</div>
                                    {% endif %}
                            </div>
                            <div class="col-md-12 mb-3">
                                <label for="id_phone_number" class="form-label">Номер телефону</label>
                                <input type="tel" class="form-control" id="id_phone_number"
                                    name="phone_number"
                                    placeholder="Введіть ваш номер телефону" 
                                    value="{{ form.phone_number.value }}">
                                    {% if form.phone_number.errors %}
                                    <div class="alert alert-danger alert-dismissible fade show">{{ form.phone_number.errors }}</div>
                                    {% endif %}
                            </div>
                            <div class="col-md-12 mb-2">
                                <h5 class="mb-1">Зміна паролю</h5>
                                <p class="text-muted small password-info">Залиште поля порожніми, якщо не бажаєте змінювати пароль</p>
                            </div>
                            <div class="col-md-12 mb-3">
                                <div class="password-field">
                                    <input type="password" class="form-control" id="id_old_password" 
                                        name="old_password" 
                                        placeholder="Введіть поточний пароль"
                                        value=""
                                        autocomplete="new-password">
                                    <button type="button" class="password-toggle" onclick="this.previousElementSibling.type = this.previousElementSibling.type === 'password' ? 'text' : 'password'; this.querySelector('i').className = this.previousElementSibling.type === 'password' ? 'bi bi-eye' : 'bi bi-eye-slash';">
                                        <i class="bi bi-eye"></i>
                                    </button>
                                </div>
                                {% if form.old_password.errors %}
                                <div class="alert alert-danger alert-dismissible fade show">{{ form.old_password.errors }}</div>
                                {% endif %}
                            </div>
                            <div class="col-md-12 mb-3">
                                <div class="password-field">
                                    <input type="password" class="form-control" id="id_password1" 
                                        name="password1" 
                                        placeholder="Введіть новий пароль">
                                    <button type="button" class="password-toggle" onclick="this.previousElementSibling.type = this.previousElementSibling.type === 'password' ? 'text' : 'password'; this.querySelector('i').className = this.previousElementSibling.type === 'password' ? 'bi bi-eye' : 'bi bi-eye-slash';">
                                        <i class="bi bi-eye"></i>
                                    </button>
                                </div>
                                {% if form.password1.errors %}
                                <div class="alert alert-danger alert-dismissible fade show">{{ form.password1.errors }}</div>
                                {% endif %}
                            </div>
                        </div>
                        <button type="submit" class="btn btn-dark">Зберегти</button>
                    </form>
                </div>
            </div>
            <!-- Корзина -->
            <div class="col-md-7">
                <div class="bg-white p-4 mb-4 mx-2 rounded custom-shadow">
                    <h3 class="text-center mb-4">Кошик</h3>
                    <div class="container px-0" id="cart-items-container">
                        <!-- Используем единый шаблон корзины -->
                        {% include "carts/includes/cart_content.html" %}
                    </div>
                </div>
            </div>
            <!-- Оформленные заказы -->
            <div class="col-md-12">
                <div class=" bg-white p-4 mb-4 mx-2 rounded custom-shadow">
                    <h3 class="text-center mb-4">Мої замовлення</h3>
                    <!-- Разметка заказов -->
                    <div class="container">
                        <div class="accordion" id="accordionExample">
                            {% if user_orders %}
                                {% for order in user_orders %}
                                <div class="accordion-item">
                                    <h2 class="accordion-header" id="heading{{ order.id }}">
                                        <button class="accordion-button {% if not forloop.first %}collapsed{% endif %}" type="button" data-bs-toggle="collapse" data-bs-target="#collapse{{ order.id }}" aria-expanded="{% if forloop.first %}true{% else %}false{% endif %}" aria-controls="collapse{{ order.id }}">
                                            Замовлення № {{ order.order_number }} - {{ order.created_at|date:"d.m.Y H:i" }} | Статус: <strong class="mx-2">{{ order.get_status_display }}</strong>
                                        </button>
                                    </h2>
                                    <div id="collapse{{ order.id }}" class="accordion-collapse collapse {% if forloop.first %}show{% endif %}" aria-labelledby="heading{{ order.id }}" data-bs-parent="#accordionExample">
                                        <div class="accordion-body">
                                            <div class="table-responsive" style="max-width: 100%; overflow-x: auto;">
                                                <table class="product-table table table-striped table-hover mb-3" style="width: 100%;">
                                                    <thead class="table-light">
                                                        <tr>
                                                            <th style="width: 40%;">АРТИКУЛ, НАЗВА ТОВАРУ</th>
                                                            <th style="width: 15%;">КІЛЬКІСТЬ</th>
                                                            <th style="width: 20%;">ЦІНА</th>
                                                            <th style="width: 25%;">СУМА</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        {% for item in order.items.all %}
                                                        <tr>
                                                            <td>
                                                                <div class="product-info">
                                                                    <span style="font-weight: 500;">{{ item.product.code }}</span><br>
                                                                    <span style="color: #555;">{{ item.product.name }}</span>
                                                                </div>
                                                            </td>
                                                            <td style="text-align: center; font-weight: 500;">{{ item.quantity }}</td>
                                                            <td style="font-weight: 500;">{{ item.price|floatformat:2 }} грн</td>
                                                            <td style="font-weight: 500;">{{ item.get_cost|floatformat:2 }} грн</td>
                                                        </tr>
                                                        {% endfor %}
                                                    </tbody>
                                                </table>
                                            </div>
                                            <div class="card shadow-lg">
                                                <div class="card-footer">
                                                    <p class="float-left">Всього позицій товарів<strong> {{ order.items.all|length }}</strong> на суму</p>
                                                    <h4 class="float-left"><strong>{{ order.get_total_cost|floatformat:2 }} грн</strong></h4>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            {% else %}
                                <div class="alert alert-info">
                                    У вас поки немає оформлених замовлень.
                                </div>
                            {% endif %}
                        </div>
                    </div>
                    <!-- Закончилась разметка заказов -->
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock content %}

{% block js %}
<!-- Скрипты для страницы профиля -->
<script>
    // Немедленное выполнение для максимально быстрой очистки поля
    (function(){
        // Создаем скрытое поле для отвлечения автозаполнения
        var fakeInput = document.createElement('input');
        fakeInput.setAttribute('type', 'password');
        fakeInput.setAttribute('style', 'display:none');
        document.body.appendChild(fakeInput);
        
        // Функция очистки полей паролей
        function clearPasswords() {
            var oldPasswordField = document.getElementById('id_old_password');
            var newPasswordField = document.getElementById('id_password1');
            
            if (oldPasswordField) {
                oldPasswordField.value = '';
                // Отключаем и включаем поле, чтобы сбросить автозаполнение
                oldPasswordField.setAttribute('disabled', 'disabled');
                setTimeout(function() { 
                    oldPasswordField.removeAttribute('disabled');
                }, 100);
            }
            
            if (newPasswordField) {
                newPasswordField.value = '';
            }
        }
        
        // Очищаем сразу
        clearPasswords();
        
        // Очищаем после загрузки DOM
        document.addEventListener('DOMContentLoaded', function() {
            clearPasswords();
            
            // Повторная попытка очистки через 500мс и 1000мс
            setTimeout(clearPasswords, 500);
            setTimeout(clearPasswords, 1000);
        });
    })();

    // При загрузке страницы очищаем поля паролей
    document.addEventListener('DOMContentLoaded', function() {
        document.getElementById('id_old_password').value = '';
        document.getElementById('id_password1').value = '';
    });
</script>
{% endblock %}