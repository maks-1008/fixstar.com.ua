{% extends "base.html" %}
{% load static %}
{% load param_helpers %}

{% block css %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.0/font/bootstrap-icons.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link rel="stylesheet" href="{% static 'deps/css/subcategory_detail.css' %}">
<link rel="stylesheet" href="{% static 'deps/css/my_footer_css.css' %}">
{% endblock %}

{% block content %}
<div class="mt-4 pt-4 bg-white custom-shadow rounded">
    <!-- Заголовок подкатегории - перенесен выше -->
    <div class="buttons-container">
        <a href="{% url 'goods:category' subcategory.category.slug %}" class="btn-return">
            ← Повернутися до списку
        </a>
        <div class="text-center flex-grow-1">
            <h2 class="page-title"><strong>{{ subcategory.name }}</strong></h2>
            <div class="filter-reset-btn">
                <a href="{{ request.path }}" class="btn-filter {% if request.GET %}active{% endif %}">
                    {% if request.GET %}Зняти фільтр{% else %}Фільтр{% endif %}
                </a>
            </div>
        </div>
        <button type="button" class="btn-expand" data-bs-toggle="modal" data-bs-target="#descriptionModal">
            Розширений опис →
        </button>
    </div>

    <!-- Основной контент -->
    <div class="m-2">
        <div class="row mt-2">
            <div class="col-md-4 product-image-container d-flex justify-content-center align-items-start">
                <div class="image-frame text-center" data-bs-toggle="modal" data-bs-target="#descriptionModal" style="cursor: pointer;">
                    {% if subcategory.image %}
                    <img src="{{ subcategory.image.url }}" class="product-image" alt="{{ subcategory.name }}">
                    {% else %}
                    <img src="{% static 'deps/images/Not found image.png' %}" class="product-image" alt="Нет изображения">
                    {% endif %}
                </div>
            </div>
            
            <div class="col-md-8">  
                <div class="filter-line">
                    <!-- Клас міцності -->
                    <div class="filter-group">
                        <span class="filter-label">Клас міцності:</span>
                        <div class="filter-options">
                            {% for sc in strength_classes %}
                                <a href="?{% if request.GET.strength_class == sc %}{{ request.GET.urlencode|remove_param:'strength_class' }}{% else %}{{ request.GET.urlencode|remove_param:'strength_class' }}&strength_class={{ sc }}{% endif %}" 
                                    class="filter-link {% if request.GET.strength_class == sc %}active{% endif %}">
                                    {{ sc }}
                                </a>
                            {% endfor %}
                        </div>
                    </div>

                    <!-- Покриття -->
                    <div class="filter-group">
                        <span class="filter-label">Покриття:</span>
                        <div class="filter-options">
                            {% for coating in coatings %}
                                <a href="?{% if request.GET.coating == coating %}{{ request.GET.urlencode|remove_param:'coating' }}{% else %}{{ request.GET.urlencode|remove_param:'coating' }}&coating={{ coating }}{% endif %}" 
                                    class="filter-link {% if request.GET.coating == coating %}active{% endif %}">
                                    {{ coating }}
                                </a>
                            {% endfor %}
                        </div>
                    </div>

                    <!-- Діаметр -->
                    <div class="filter-group">
                        <span class="filter-label">Діаметр, мм:</span>
                        <div class="filter-options">
                            {% for diameter in diameters %}
                                <a href="?{% if request.GET.diameter == diameter %}{{ request.GET.urlencode|remove_param:'diameter' }}{% else %}{{ request.GET.urlencode|remove_param:'diameter' }}&diameter={{ diameter }}{% endif %}" 
                                    class="filter-link {% if request.GET.diameter == diameter %}active{% endif %}">
                                    {{ diameter }}
                                </a>
                            {% endfor %}
                        </div>
                    </div>

                    <!-- Довжина -->
                    <div class="filter-group">
                        <span class="filter-label">Довжина, мм:</span>
                        <div class="filter-options">
                            {% for length in lengths %}
                                <a href="?{% if request.GET.lengths == length %}{{ request.GET.urlencode|remove_param:'lengths' }}{% else %}{{ request.GET.urlencode|remove_param:'lengths' }}&lengths={{ length }}{% endif %}" 
                                    class="filter-link {% if request.GET.lengths == length %}active{% endif %}">
                                    {{ length }}
                                </a>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Заголовок по центру -->
            <div class="d-flex justify-content-center mb-0">
                <h3 class="text-center" style="font-weight: bold;">СПИСОК ТОВАРІВ</h3>
            </div>
            <!-- Таблица товаров с улучшенными стилями -->
            <div class="table-responsive" style="max-width: 100%; overflow-x: auto;">
                <table class="product-table table table-striped table-hover mb-4" style="width: 100%;">
                    <thead class="table-light">
                        <tr>
                            <th style="width: 40%;">АРТИКУЛ, НАЗВА ТОВАРУ</th>
                            <th style="width: 15%;">ПАРТІЯ</th>
                            <th style="width: 20%;">ЦІНА</th>
                            <th style="width: 25%;">КІЛЬКІСТЬ</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for product in page_obj %}
                        <tr>
                            <td>
                                <div class="product-info">
                                    <span style="font-weight: 500;">
                                        {% if product.highlighted_code %}
                                            {{ product.highlighted_code|safe }}
                                        {% else %}
                                            {{ product.code }}
                                        {% endif %}
                                    </span><br>
                                    <span style="color: #555;">
                                        {% if product.highlighted_name %}
                                            {{ product.highlighted_name|safe }}
                                        {% else %}
                                            {{ product.name }}
                                        {% endif %}
                                    </span>
                                </div>
                            </td>
                            <td>
                                {% if product.quantity > 0 %}
                                <span class="badge bg-success" data-available-quantity="{{ product.quantity }}">
                                    <i class="bi bi-check-circle me-1"></i>
                                    {% if user.is_authenticated and 'Партнер' in user.groups.all|stringformat:'s' %}
                                        В наявності ({{ product.quantity }} шт.)
                                    {% else %}
                                        В наявності
                                    {% endif %}
                                </span>
                                {% else %}
                                <span class="badge bg-danger">
                                    <i class="bi bi-x-circle me-1"></i>
                                    Немає
                                </span>
                                {% endif %}
                                {% if product.batch %}
                                <div class="small text-muted mt-1">
                                    {% if user.is_authenticated and 'Партнер' in user.groups.all|stringformat:'s' %}
                                        {{ product.batch }}
                                    {% else %}
                                        <span class="text-muted">Доступно для партнерів</span>
                                    {% endif %}
                                </div>
                                {% endif %}
                            </td>
                            <td style="font-weight: 500;">{{ product.price|floatformat:2 }} грн (за шт.)</td>
                            <td style="vertical-align: middle;">
                                <form class="add-to-cart-form d-flex align-items-center" method="post" action="{% url 'cart:cart_add' product.id %}">
                                    {% csrf_token %}
                                    <input 
                                        type="number"
                                        min="1"
                                        value="1"
                                        name="quantity"
                                        class="form-control quantity-input me-2"
                                        style="width: 70px;"
                                        data-product-id="{{ product.id }}">
                                    
                                    <button type="submit" class="btn btn-dark add-to-cart d-flex align-items-center"
                                        style="padding: 6px 10px; background-color: #ffa023; border-color: #ddd; color: white;">
                                        <img src="{% static 'deps/icons/basket2-fill.svg' %}" 
                                            alt="В кошик" 
                                            width="16" 
                                            class="me-1"
                                            style="filter: brightness(100);">
                                        В кошик
                                    </button>
                                </form>
                            </td>
                        </tr>
                        {% empty %}
                            <tr>
                                <td colspan="4" class="text-center">Товари не знайдено</td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
    </div>
</div>

<!-- Subcategory description modal -->
<div class="modal fade" id="descriptionModal" tabindex="-1" aria-labelledby="descriptionModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="descriptionModalLabel">{{ subcategory.name }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-0">
                <div class="description-image-container">
                    {% if subcategory.description_image %}
                    <img src="{{ subcategory.description_image.url }}" class="img-fluid" alt="Розширений опис {{ subcategory.name }}">
                    {% else %}
                    <img src="{% static 'deps/images/Not found image.png' %}" class="img-fluid" alt="Розширений опис">
                    {% endif %}
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрити</button>
            </div>
        </div>
    </div>
</div>
<!-- Toast уведомления -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 11">
    <div id="liveToast" class="toast hide" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header">
            <strong class="me-auto">Кошик</strong>
            <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div class="toast-body"></div>
    </div>
</div>
{% endblock %}

{% block footer %}
<footer class="footer-custom bg-dark">
    <div class="container">
        <p class="m-0 text-center text-white">&copy; FixStar 2024 Всі права захищені</p>
    </div>
</footer>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
{% endblock %}
{% block javascript %}
<script src="{% static 'deps/js/subcategory_detail.js' %}"></script>
{% endblock %}
