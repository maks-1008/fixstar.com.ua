{% extends "base.html" %}
{% load static %}
{% load param_helpers %}


{% block css %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.0/font/bootstrap-icons.css">
<link rel="stylesheet" href="{% static 'deps/css/subcategory_detail.css' %}">
<link rel="stylesheet" href="{% static 'deps/css/my_footer_css.css' %}">
<link rel="stylesheet" href="{% static 'deps/css/search_results.css' %}">
{% endblock %}

{% block content %}
<div class="mt-4 pt-4 bg-white custom-shadow rounded">
    <!-- Заголовок -->
    <div class="justify-content-center mb-2">
        <h3 class="text-center" style="font-weight: bold;">Знайдено товарів: {{ page_obj.paginator.count }}</h3>
    </div>
    <!-- Таблица товаров -->
    <div class="m-2">
        <div class="table-responsive" style="max-width: 100%; overflow-x: auto;">
            <table class="product-table table table-striped table-hover mb-4" style="width: 100%;">
                <thead class="table-light">
                    <tr>
                        <th style="width: 8%;"></th>
                        <th style="width: 30%;">АРТИКУЛ, НАЗВА ТОВАРУ</th>
                        <th style="width: 15%;">ПАРТІЯ</th>
                        <th style="width: 20%;">ЦІНА</th>
                        <th style="width: 25%;">КІЛЬКІСТЬ</th>
                    </tr>
                </thead>
                <tbody>
                    {% for product in page_obj %}
                        <tr>
                            <td>
                                <a href="#" data-bs-toggle="modal" data-bs-target="#imageModal{{ product.id }}">
                                    {% if product.image %}
                                    <img src="{{ product.image.url }}" class="img-thumbnail" alt="{{ product.name }}" style="width: 60px; height: 60px; object-fit: contain;">
                                    {% else %}
                                    <img src="{% static 'deps/images/Not found image.png' %}" class="img-thumbnail" alt="Нет изображения" style="width: 60px; height: 60px; object-fit: contain;">
                                    {% endif %}
                                </a>
                            </td>
                            <td>
                                <div class="product-info">
                                    <span style="font-weight: 500;">
                                        {% if product.highlighted_code %}
                                            {{ product.highlighted_code|safe }}
                                        {% else %}
                                            {{ product.code }}
                                        {% endif %}
                                    </span><br>
                                    <span style="color: #555;">
                                        {% if product.highlighted_name %}
                                            {{ product.highlighted_name|safe }}
                                        {% else %}
                                            {{ product.name }}
                                        {% endif %}
                                    </span>
                                </div>
                            </td>
                            <td>
                                {% if product.quantity > 0 %}
                                <span class="badge bg-success" data-available-quantity="{{ product.quantity }}">
                                    <i class="bi bi-check-circle me-1"></i>
                                    В наявності ({{ product.quantity }} шт.)
                                </span>
                                {% else %}
                                <span class="badge bg-danger">
                                    <i class="bi bi-x-circle me-1"></i>
                                    Немає
                                </span>
                                {% endif %}
                                {% if product.batch %}
                                <div class="small text-muted mt-1">{{ product.batch }}</div>
                                {% endif %}
                            </td>
                            <td style="font-weight: 500;">{{ product.price|floatformat:2 }} грн (за шт.)</td>
                            <td style="vertical-align: middle;">
                                <form class="add-to-cart-form d-flex align-items-center" method="post" action="{% url 'cart:cart_add' product.id %}">
                                    {% csrf_token %}
                                    <input 
                                        type="number"
                                        min="1"
                                        value="1"
                                        name="quantity"
                                        class="form-control quantity-input me-2"
                                        style="width: 70px;"
                                        data-product-id="{{ product.id }}">
                                 
                                    <button type="submit" class="btn btn-dark add-to-cart d-flex align-items-center"
                                        style="padding: 6px 10px; background-color: #ffa023; border-color: #ddd; color: white;">
                                        <img src="{% static 'deps/icons/basket2-fill.svg' %}" 
                                            alt="В кошик" 
                                            width="16" 
                                            class="me-1"
                                            style="filter: brightness(100);">
                                        В кошик
                                    </button>
                                </form>
                            </td>
                        </tr>
                    {% empty %}
                        <tr>
                            <td colspan="4" class="text-center">Товари не знайдено</td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
<!-- Модальные окна для изображений товаров -->
{% for product in page_obj %}
<div class="modal fade" id="imageModal{{ product.id }}" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">{{ product.name }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center">
                {% if product.image %}
                <img src="{{ product.image.url }}" class="img-fluid" alt="{{ product.name }}" style="max-height: 70vh;">
                {% else %}
                <img src="{% static 'deps/images/Not found image.png' %}" class="img-fluid" alt="Нет изображения" style="max-height: 70vh;">
                {% endif %}
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрити</button>
            </div>
        </div>
    </div>
</div>
{% endfor %}
<!-- Toast уведомления -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 11">
    <div id="liveToast" class="toast hide" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header">
            <strong class="me-auto">Кошик</strong>
            <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div class="toast-body"></div>
    </div>
</div>
{% endblock %}

{% block footer %}
<footer class="footer-custom bg-dark">
    <div class="container">
        <p class="m-0 text-center text-white">&copy; FixStar {% now "Y" %} Всі права захищені</p>
    </div>
</footer>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
{% endblock %}

{% block javascript %}
function updateCartUI() {
<script src="{% static 'deps/js/cart_quantity_validation.js' %}"></script>
}
{% endblock %}