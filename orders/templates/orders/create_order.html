{% extends "base.html" %}
{% load static %}
{% load carts_tags %}

{% block content %}
<div class=" bg-white p-4 mb-4 mx-2 rounded custom-shadow">
    <div class="container">
        <h3 class="text-center mb-4">Обрані товари</h3>
        <div class="container" id="cart-items-container">
            <!-- Разметка корзины -->
            {% user_carts request as carts %}

            {% with current_page='create_order' %}
            {% include "carts/includes/included_cart.html" %}
            {% endwith %}
            <!-- Закончилась разметка корзины -->
        </div>
    </div>
    <!-- Детали заказа -->
    <div class="container">
        <h3 class="text-center">Деталі замовлення</h3>
        <div class="card mb-3">
            <div class="card-body">
                <form action="{% url "orders:create_order" %}" method="post" id="create_order_form">
                    {% csrf_token %}
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="id_first_name" class="form-label">Ім'я*:</label>
                            <input type="text" class="form-control" id="id_first_name"
                                value="{% if form.first_name.value %}{{ form.first_name.value }}{% endif %}"
                                name="first_name" required>
                            {% if form.first_name.errors %}
                                <div class="alert alert-danger alert-dismissible fade show">{{form.first_name.errors}}</div>
                            {% endif %}
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="id_last_name" class="form-label">Прізвище*:</label>
                            <input type="text" class="form-control" id="id_last_name" name="last_name"
                            value="{% if form.last_name.value %}{{ form.last_name.value }}{% endif %}"
                            required>
                            {% if form.last_name.errors %}
                                <div class="alert alert-danger alert-dismissible fade show">{{form.last_name.errors}}</div>
                            {% endif %}
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="id_phone_number" class="form-label">Номер телефону*:</label>
                            <input type="text" class="form-control" id="id_phone_number" name="phone_number"
                                value="{% if form.phone_number.value %}{{ form.phone_number.value }}{% endif %}"
                                placeholder="(000) 000-0000"
                                required>
                            {% if form.phone_number.errors %}
                                <div class="alert alert-danger alert-dismissible fade show">{{form.phone_number.errors}}</div>
                            {% endif %}
                            <div class="alert alert-danger alert-dismissible fade show" style="display: none" id="phone_number_error">Невірний формат номеру</div>
                        </div>
                        <div class="col-md-12 mb-3" id="delivery-method-selector">
                            <label for="delivery" class="form-label">Спосіб доставки: </label>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="requires_delivery"
                                    id="id_requires_delivery_1" value="True" checked>
                                <label class="form-check-label" for="id_requires_delivery_1">Потрібна
                                    доставка</label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="requires_delivery"
                                    id="id_requires_delivery_0" value="False">
                                <label class="form-check-label" for="id_requires_delivery_0">Самовивіз</label>
                            </div>
                        </div>
                                            
                        <!-- Поле адреса - видимо только при выборе доставки -->
                        <div class="col-md-12 mb-3" id="delivery-address-container">
                            <div class="mb-3">
                                <label for="id_delivery_address" class="form-label">Адреса
                                    доставки*:</label>
                                <textarea class="form-control" id="id_delivery_address"
                                    name="delivery_address" rows="2">{% if form.delivery_address.value %}{{ form.delivery_address.value }}{% endif %}</textarea>
                                {% if form.delivery_address.errors %}
                                    <div class="alert alert-danger alert-dismissible fade show" id="delivery_address_error">
                                        {{form.delivery_address.errors}}
                                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <div class="col-md-12 mb-3">
                            <label class="form-label">Спосіб оплати: </label>
                            <div class="payment-methods">
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="radio" name="payment_method"
                                        id="id_payment_method_card" value="card" checked>
                                    <label class="form-check-label" for="id_payment_method_card">Оплата картою</label>
                                </div>
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="radio" name="payment_method"
                                        id="id_payment_method_cash" value="cash">
                                    <label class="form-check-label" for="id_payment_method_cash">Готівкою/картою при отриманні</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="payment_method"
                                        id="id_payment_method_bank" value="bank">
                                    <label class="form-check-label" for="id_payment_method_bank">Оплата на розрахунковий рахунок підприємства</label>
                                </div>
                                {% if form.payment_method.errors %}
                                    <div class="alert alert-danger alert-dismissible fade show mt-2">{{form.payment_method.errors}}</div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    <button type="submit" class="btn" style="background-color: #ffa023; color: white;">Оформити замовлення</button>
                </form>
            </div>
        </div>
    </div>
</div>

<style>
/* Стили для управления видимостью блока адреса доставки */
#delivery-address-container {
    max-height: 200px;
    overflow: hidden;
    transition: max-height 0.3s ease;
}
#delivery-address-container.hidden {
    max-height: 0;
    overflow: hidden;
    padding: 0;
    margin: 0;
}
</style>

<script>
// Немедленно выполняющийся скрипт для настройки переключения между способами доставки
(function() {
    // Функция для управления отображением блока адреса доставки
    function setupDeliveryToggle() {
        // Получаем ссылки на элементы DOM
        var deliveryMethodRadios = document.querySelectorAll('input[name="requires_delivery"]');
        var addressContainer = document.getElementById('delivery-address-container');
        var addressInput = document.getElementById('id_delivery_address');
        
        // Проверяем, что элементы найдены
        if (!deliveryMethodRadios || !addressContainer || !addressInput) {
            console.error('Не удалось найти все необходимые элементы для переключения способа доставки');
            return;
        }
        
        // Обработчик выбора способа доставки
        function handleDeliveryMethodChange() {
            // Проверяем, выбрана ли доставка (True) или самовывоз (False)
            var needsDelivery = document.getElementById('id_requires_delivery_1').checked;
            
            console.log('Изменение способа доставки. Нужна доставка:', needsDelivery);
            
            if (needsDelivery) {
                // Если выбрана доставка, показываем поле адреса
                addressContainer.classList.remove('hidden');
            } else {
                // Если выбран самовывоз, скрываем поле адреса и очищаем его
                addressContainer.classList.add('hidden');
                addressInput.value = '';
            }
        }
        
        // Назначаем обработчики событий для радиокнопок
        deliveryMethodRadios.forEach(function(radio) {
            radio.addEventListener('change', handleDeliveryMethodChange);
            radio.addEventListener('click', handleDeliveryMethodChange);
        });
        
        // Устанавливаем начальное состояние при загрузке страницы
        handleDeliveryMethodChange();
        
        // Для отладки
        console.log('Настройка переключения доставки завершена');
    }
    
    // Пытаемся выполнить настройку перед полной загрузкой DOM
    setupDeliveryToggle();
    
    // Также пытаемся выполнить настройку после загрузки DOM для надежности
    document.addEventListener('DOMContentLoaded', function() {
        console.log('DOM загружен, повторная настройка переключения доставки');
        setupDeliveryToggle();
        
        // Проверка формы перед отправкой
        var form = document.getElementById('create_order_form');
        var phoneInput = document.getElementById('id_phone_number');
        var phoneError = document.getElementById('phone_number_error');
        var deliveryAddressInput = document.getElementById('id_delivery_address');
        
        if (form) {
            form.addEventListener('submit', function(event) {
                // Проверяем, требуется ли доставка
                var deliveryRequired = document.getElementById('id_requires_delivery_1').checked;
                
                // Проверка формата телефона
                var phoneValue = phoneInput.value.trim();
                var phoneRegex = /^[\+]?[(]?[0-9]{3}[)]?[-\s\.]?[0-9]{3}[-\s\.]?[0-9]{4,6}$/;
                
                if (!phoneRegex.test(phoneValue)) {
                    event.preventDefault();
                    phoneError.style.display = 'block';
                    phoneInput.classList.add('is-invalid');
                }
                
                // Проверяем заполнение адреса, если требуется доставка
                if (deliveryRequired) {
                    var addressValue = deliveryAddressInput.value.trim();
                    if (!addressValue) {
                        event.preventDefault();
                        deliveryAddressInput.classList.add('is-invalid');
                        
                        // Создаем сообщение об ошибке, если оно отсутствует
                        var errorElement = document.getElementById('delivery_address_error');
                        if (!errorElement) {
                            var errorDiv = document.createElement('div');
                            errorDiv.id = 'delivery_address_error';
                            errorDiv.className = 'alert alert-danger alert-dismissible fade show';
                            errorDiv.textContent = 'Вкажіть адресу доставки';
                            
                            var closeButton = document.createElement('button');
                            closeButton.type = 'button';
                            closeButton.className = 'btn-close';
                            closeButton.setAttribute('data-bs-dismiss', 'alert');
                            closeButton.setAttribute('aria-label', 'Close');
                            
                            errorDiv.appendChild(closeButton);
                            deliveryAddressInput.parentNode.appendChild(errorDiv);
                        } else {
                            errorElement.style.display = 'block';
                        }
                    }
                }
            });
        }
        
        // Скрытие ошибки телефона при вводе нового значения
        if (phoneInput) {
            phoneInput.addEventListener('input', function() {
                if (phoneError) {
                    phoneError.style.display = 'none';
                }
                phoneInput.classList.remove('is-invalid');
            });
        }
        
        // Скрытие ошибки адреса при вводе нового значения
        if (deliveryAddressInput) {
            deliveryAddressInput.addEventListener('input', function() {
                var errorElement = document.getElementById('delivery_address_error');
                if (errorElement) {
                    errorElement.style.display = 'none';
                }
                deliveryAddressInput.classList.remove('is-invalid');
            });
        }
    });
})();

// Установка после полной загрузки страницы (включая изображения и стили)
window.onload = function() {
    console.log('Страница полностью загружена, проверка переключения доставки');
    // Проверяем еще раз состояние доставки
    var needsDelivery = document.getElementById('id_requires_delivery_1').checked;
    var addressContainer = document.getElementById('delivery-address-container');
    
    if (addressContainer) {
        if (needsDelivery) {
            addressContainer.classList.remove('hidden');
        } else {
            addressContainer.classList.add('hidden');
        }
    }
};
</script>
{% endblock %}